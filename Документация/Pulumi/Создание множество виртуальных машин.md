import pulumi

import pulumi_proxmoxve as proxmoxve

  
  

# download config

config = pulumi.Config("proxmox")

endpoint = config.require("endpoint")

username = config.require("username")

password = config.require_secret("password")  

  

# Provider connection to proxmox

provider = proxmoxve.Provider(

    "proxmoxve",

    endpoint=endpoint,

    username=username,

    password=password,

    insecure=True

)

  

vm_count=6

vms=[]

ips=[]

  

for i in range(1, vm_count + 1):

    ip_address = f"192.168.0.{129 + i}/24"

  

    vm = proxmoxve.vm.VirtualMachine(

    resource_name=f"vm-{i}",

    node_name="srv0",        

    vm_id=900 + i,              

    name=f"pulumi-vm-{i}",

    agent=proxmoxve.vm.VirtualMachineAgentArgs(

        enabled=False,

        trim=True,

        type="virtio"

    ),

    bios="seabios",

    memory=proxmoxve.vm.VirtualMachineMemoryArgs(

        dedicated=2048

    ),

    cpu=proxmoxve.vm.VirtualMachineCpuArgs(

        cores=2,

        sockets=1

    ),

    clone=proxmoxve.vm.VirtualMachineCloneArgs(

        node_name="srv0",

        vm_id=9000,

        full=True

    ),

  

    disks=[

        proxmoxve.vm.VirtualMachineDiskArgs(

            interface="scsi0",

            datastore_id="local-lvm",

            size=20,              

            file_format="qcow2"

        )

    ],

    cdrom=proxmoxve.vm.VirtualMachineCdromArgs(

        interface="ide2",

        file_id="none"

    ),

    network_devices=[

        proxmoxve.vm.VirtualMachineNetworkDeviceArgs(

            bridge="vmbr0",

            model="virtio"

        )

    ],

    on_boot=True,

    operating_system=proxmoxve.vm.VirtualMachineOperatingSystemArgs(type="other"),

    initialization=proxmoxve.vm.VirtualMachineInitializationArgs(

        type="nocloud",

        datastore_id="local-lvm",

        dns=proxmoxve.vm.VirtualMachineInitializationDnsArgs(

            domain="example.com",

            servers=["1.1.1.1", "8.8.8.8"]

        ),

        ip_configs=[

             proxmoxve.vm.VirtualMachineInitializationIpConfigArgs(

                ipv4=proxmoxve.vm.VirtualMachineInitializationIpConfigIpv4Args(

                    address=ip_address,

                    gateway="192.168.0.1"

                )

            )

        ],

        user_account=proxmoxve.vm.VirtualMachineInitializationUserAccountArgs(

            username="user",

            password="password123",

            keys=["ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFUtZqqero06gd3lgq2OfUYzU7q3b+gRvaPs3I64j1XW proxmox_srv0"]

        )

    ),

    opts=pulumi.ResourceOptions(provider=provider)

)

vms.append(vm)

ips.append(ip_address.split("/")[0])

  

# pulumi.export("vm_names", [vm.name for vm in vms])

# pulumi.export("vm_ips", ips)