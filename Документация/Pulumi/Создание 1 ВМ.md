import pulumi
import pulumi_command as command
import pulumi_proxmoxve as proxmoxve


# Подключение к Proxmox через провайдер
# download config

config = pulumi.Config("proxmox")

endpoint = config.require("endpoint")

username = config.require("username")

password = config.require_secret("password")  

  

# Provider connection to proxmox

provider = proxmoxve.Provider(

    "proxmoxve",

    endpoint=endpoint,

    username=username,

    password=password,

    insecure=True

)


vm = proxmoxve.vm.VirtualMachine(
    resource_name="vm",
    node_name="srv0",        
    vm_id=900,               
    name="pulumi-test-vm",
    agent=proxmoxve.vm.VirtualMachineAgentArgs(
        enabled=False,
        trim=True,
        type="virtio"
    ),
    bios="seabios",
    memory=proxmoxve.vm.VirtualMachineMemoryArgs(
        dedicated=2048
    ),
    cpu=proxmoxve.vm.VirtualMachineCpuArgs(
        cores=2,
        sockets=1
    ),
    clone=proxmoxve.vm.VirtualMachineCloneArgs(
        node_name="srv0",
        vm_id=9000,
        full=True
    ),

    disks=[
        proxmoxve.vm.VirtualMachineDiskArgs(
            interface="scsi0",
            datastore_id="local-lvm",
            size=20,              
            file_format="qcow2"
        )
    ],
    cdrom=proxmoxve.vm.VirtualMachineCdromArgs(
        interface="ide2",
        file_id="none"
    ),
    network_devices=[
        proxmoxve.vm.VirtualMachineNetworkDeviceArgs(
            bridge="vmbr0",
            model="virtio"
        )
    ],
    on_boot=True,
    operating_system=proxmoxve.vm.VirtualMachineOperatingSystemArgs(type="other"),
    initialization=proxmoxve.vm.VirtualMachineInitializationArgs(
        type="nocloud",
        datastore_id="local-lvm",
        dns=proxmoxve.vm.VirtualMachineInitializationDnsArgs(
            domain="example.com",
            servers=["1.1.1.1", "8.8.8.8"]
        ),
        ip_configs=[
             proxmoxve.vm.VirtualMachineInitializationIpConfigArgs(
                ipv4=proxmoxve.vm.VirtualMachineInitializationIpConfigIpv4Args(
                    address="192.168.0.253/24",
                    gateway="192.168.0.1"
                )
            )
        ],
        user_account=proxmoxve.vm.VirtualMachineInitializationUserAccountArgs(
            username="test_user",
            password="userpassword123"
        )
    ),
    opts=pulumi.ResourceOptions(provider=provider)
    
)


# Экспортируем имя VM
pulumi.export("vm_name", vm.name)